
# Verify and Decode Secret

## 1. Verify Secret:
```
kubectl get secret my-secret
```
Output:
```
NAME        TYPE     DATA   AGE
my-secret   Opaque   2      3s
```

## 2. Decode Secret:
```
kubectl get secret my-secret -o jsonpath='{.data.username}' | base64 --decode
```
Output:
```
Markuuu_s
```

## Helm Deployment:
```
helm secrets install python ./python-app-helm/ -f secrets.yaml --values ./python-app-helm/values.yaml
``` 

Output:
```
NAME: python
LAST DEPLOYED: Tue Nov 14 19:06:30 2023
NAMESPACE: default
STATUS: deployed
REVISION: 1
NOTES:
1. Get the application URL by running these commands:
     NOTE: It may take a few minutes for the LoadBalancer IP to be available.
           You can watch the status of by running 'kubectl get --namespace default svc -w python-python-app'
  export SERVICE_IP=$(kubectl get svc --namespace default python-python-app --template "{{ range (index .status.loadBalancer.ingress 0) }}{{.}}{{ end }}")
  echo http://$SERVICE_IP:8080
```

## Retrieve List of Pods:
```
kubectl get po
```
Output:
```
NAME                                 READY   STATUS    RESTARTS   AGE
python-python-app-84797ff5d7-kxvr8   1/1     Running   0          5m49s
python-python-app-84797ff5d7-q6cxd   1/1     Running   0          5m49s
python-python-app-84797ff5d7-tn9mv   1/1     Running   0          5m49s
```

## Verify Secret inside Pod:
```
kubectl exec python-python-app-84797ff5d7-kxvr8 -- printenv | grep MY_PASS
```
Output:
```
MY_PASS=PassMuurrk
```

## Install vault and verify
```
kubectl get pods
```

Output:
```
NAME                                    READY   STATUS    RESTARTS   AGE
vault-0                                 1/1     Running   0          4m3s
vault-agent-injector-766db8894f-lnbxw   1/1     Running   0          4m4s
```

```
mark@Mark-desctop:~/core-course-labs/k8s$ kubectl exec -it vault-0 -- /bin/sh
/ $ vault secrets enable -path=internal kv-v2
Success! Enabled the kv-v2 secrets engine at: internal/
/ $ vault kv put internal/database/config username="db-readonly-username" password="db-secret-password"
======== Secret Path ========
internal/data/database/config

======= Metadata =======
Key                Value
---                -----
created_time       2023-11-14T18:11:06.248676095Z
custom_metadata    <nil>
deletion_time      n/a
destroyed          false
version            1
/ $ vault kv get internal/database/config
======== Secret Path ========
internal/data/database/config

======= Metadata =======
Key                Value
---                -----
created_time       2023-11-14T18:11:06.248676095Z
custom_metadata    <nil>
deletion_time      n/a
destroyed          false
version            1

====== Data ======
Key         Value
---         -----
password    db-secret-password
username    db-readonly-username
/ $ vault auth enable kubernetes
Success! Enabled kubernetes auth method at: kubernetes/
/ $ vault write auth/kubernetes/config kubernetes_host="https://$KUBERNETES_PORT_443_TCP_ADDR:443"
Success! Data written to: auth/kubernetes/config
/ $ vault policy write internal-app - <<EOF
> path "internal/data/database/config" {
>    capabilities = ["read"]
> }
> EOF
Success! Uploaded policy: internal-app
/ $ vault write auth/kubernetes/role/internal-app \
>       bound_service_account_names=python-python-app \
>       bound_service_account_namespaces=default \
>       policies=internal-app \
>       ttl=24h
Success! Data written to: auth/kubernetes/role/internal-app
/ $ 
```

```
mark@Mark-desctop:~/core-course-labs/k8s$ kubectl get sa -n default
NAME                   SECRETS   AGE
default                0         109m
python-python-app      0         27s
vault                  0         28m
vault-agent-injector   0         28m
mark@Mark-desctop:~/core-course-labs/k8s$ kubectl get pods -A
NAMESPACE     NAME                                    READY   STATUS    RESTARTS       AGE
default       python-python-app-69784d675d-n87v8      2/2     Running   0              20m
default       python-python-app-69784d675d-vjsgs      2/2     Running   0              20m
default       python-python-app-69784d675d-x2tj5      2/2     Running   0              20m
default       vault-0                                 1/1     Running   0              47m
default       vault-agent-injector-766db8894f-lnbxw   1/1     Running   0              47m
kube-system   coredns-5dd5756b68-7w755                1/1     Running   0              129m
kube-system   etcd-minikube                           1/1     Running   0              130m
kube-system   kube-apiserver-minikube                 1/1     Running   0              130m
kube-system   kube-controller-manager-minikube        1/1     Running   0              130m
kube-system   kube-proxy-85mgc                        1/1     Running   0              129m
kube-system   kube-scheduler-minikube                 1/1     Running   0              130m
kube-system   storage-provisioner                     1/1     Running   1 (129m ago)   130m
mark@Mark-desctop:~/core-course-labs/k8s$ kubectl exec  python-python-app-69784d675d-n87v8  -it /bin/sh
kubectl exec [POD] [COMMAND] is DEPRECATED and will be removed in a future version. Use kubectl exec [POD] -- [COMMAND] instead.
Defaulted container "python-app" out of: python-app, vault-agent, vault-agent-init (init)
/app $  cat /vault/secrets/database-config.txt 
data: map[password:db-secret-password username:db-readonly-username]
metadata: map[created_time:2023-11-14T18:11:06.248676095Z custom_metadata:<nil> deletion_time: destroyed:false version:1]
/app $ df -h
Filesystem                Size      Used Available Use% Mounted on
overlay                  17.0G      1.6G     14.4G  10% /
tmpfs                    64.0M         0     64.0M   0% /dev
tmpfs                     2.8G         0      2.8G   0% /sys/fs/cgroup
tmpfs                     5.7G      4.0K      5.7G   0% /vault/secrets
/dev/sda1                17.0G      1.6G     14.4G  10% /dev/termination-log
/dev/sda1                17.0G      1.6G     14.4G  10% /etc/resolv.conf
/dev/sda1                17.0G      1.6G     14.4G  10% /etc/hostname
/dev/sda1                17.0G      1.6G     14.4G  10% /etc/hosts
shm                      64.0M         0     64.0M   0% /dev/shm
tmpfs                     5.7G     12.0K      5.7G   0% /run/secrets/kubernetes.io/serviceaccount
tmpfs                     2.8G         0      2.8G   0% /proc/asound
tmpfs                     2.8G         0      2.8G   0% /proc/acpi
tmpfs                    64.0M         0     64.0M   0% /proc/kcore
tmpfs                    64.0M         0     64.0M   0% /proc/keys
tmpfs                    64.0M         0     64.0M   0% /proc/timer_list
tmpfs                     2.8G         0      2.8G   0% /proc/scsi
tmpfs                     2.8G         0      2.8G   0% /sys/firmware
/app $ 
```